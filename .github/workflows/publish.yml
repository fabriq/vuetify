name: Publish
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'fabriq' }}
    steps:
      - uses: actions/checkout@v2
        with:
          ref: compat
          fetch-depth: 0
      - uses: ./.github/actions/yarn-install
      - run: >-
          node -e "
            const json = require('./lerna.json');
            delete json.command.publish.allowBranch;
            fs.writeFileSync('./lerna.json', JSON.stringify(json, null, 2))"
        shell: bash
      - id: get-version
        run: echo "version=$(node -e "console.log(require('./lerna.json').version)")" >> $GITHUB_OUTPUT
        shell: bash
      - run: yarn lerna version ${{ steps.get-version.outputs.version }} --no-push --no-commit-hooks --force-publish --yes
        shell: bash
      - run: yarn lerna run build --scope @vuetify/nightly
        shell: bash
      - run: yarn lerna run build --scope @vuetify/api-generator
        shell: bash
      - name: Publish package
        run: |
          echo "//npm.pkg.github.com/:_authToken=$GITHUB_TOKEN" > ~/.npmrc
          npm publish
        shell: bash
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
